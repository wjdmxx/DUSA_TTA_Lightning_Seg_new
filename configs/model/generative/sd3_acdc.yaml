# SD3 Generative Model Configuration
# Stable Diffusion 3 for TTA

# Model path
model_path: stabilityai/stable-diffusion-3-medium-diffusers

# VAE configuration
vae:
  device: cuda:0

# Transformer configuration (dispatched across GPUs)
transformer:
  # Device mapping: "balanced" | "auto" | explicit dict
  # "balanced" automatically distributes across available GPUs
  device_map: balanced
  input_device: cuda:0
  output_device: cuda:0
  # Enable gradient checkpointing to save memory
  gradient_checkpointing: true

# Preprocessing
preprocess:
  normalize_range: [-1, 1]

# Short edge resize (independent from discriminative model)
short_edge_size: 1080

# 2D sliding window configuration
# Slides in both H and W directions like a convolution kernel
sliding_window:
  size: 512      # Window size (square)
  stride: 171    # Stride for both H and W directions

# Loss configuration
loss:
  class_select_method: topk  # Class selection method: "topk" or "area_k"
  topk: 1                    # Number of top classes per pixel (used by "topk" method)
  classes_max_num: 20        # Max unique classes (exceed -> mask unselected pixels)
  classes_min_num: 0         # Min unique classes (below -> weighted sampling to fill)
  temperature: 1.0           # Softmax temperature
  # Area-K parameters (used when class_select_method == "area_k")
  area_k: 5                  # Top-k classes to retain per pixel for area scoring
  area_threshold: 15.0       # Min score_c threshold to select a class

# Timestep sampling range for flow matching
timestep_range: [0.25, 0.25]

# Text embedding configuration
text_embedding:
  # To use a template format:
  prompt_template: "a dashcam photo of {}"
  
  # To use custom prompts per category, uncomment the lines below.
  # If 'custom_prompts' is defined, the system will use it and calculate the hash based on its contents.
  # If a class is missing from custom_prompts, it will fallback to using 'prompt_template'.
  # custom_prompts:
  #   "road":          "a road"
  #   "sidewalk":      "a sidewalk"
  #   "building":      "a building"
  #   "wall":          "a concrete wall"
  #   "fence":         "a fence"
  #   "pole":          "a street pole"
  #   "traffic light": "a traffic light"
  #   "traffic sign":  "a traffic sign"
  #   "vegetation":    "trees and bushes"
  #   "terrain":       "grass and dirt ground"
  #   "sky":           "the sky"
  #   "person":        "a pedestrian"
  #   "rider":         "a person on a bicycle"
  #   "car":           "a car"
  #   "truck":         "a truck"
  #   "bus":           "a city bus"
  #   "train":         "a tram on the street"
  #   "motorcycle":    "a motorcycle"
  #   "bicycle":       "a bicycle"

  cache_dir: ./embeddings_cache
