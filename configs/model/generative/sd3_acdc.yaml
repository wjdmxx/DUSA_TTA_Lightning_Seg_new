# SD3 Generative Model Configuration
# Stable Diffusion 3 for TTA

# Model path
model_path: stabilityai/stable-diffusion-3-medium-diffusers

# VAE configuration
vae:
  device: cuda:0

# Transformer configuration (dispatched across GPUs)
transformer:
  # Device mapping: "balanced" | "auto" | explicit dict
  # "balanced" automatically distributes across available GPUs
  device_map: balanced
  input_device: cuda:0
  output_device: cuda:0
  # Enable gradient checkpointing to save memory
  gradient_checkpointing: true

# Preprocessing
preprocess:
  normalize_range: [-1, 1]

# Short edge resize (independent from discriminative model)
short_edge_size: 1080

# 2D sliding window configuration
# Slides in both H and W directions like a convolution kernel
sliding_window:
  size: 512      # Window size (square)
  stride: 171    # Stride for both H and W directions
  mode: grid     # "grid" (固定网格滑窗) | "adaptive" (熵引导自适应窗口)
  # Adaptive window params (仅 mode=adaptive 时生效)
  adaptive:
    entropy_threshold: null   # 熵阈值, null=自动 (mean + 0.5*std)
    min_box_size: 128         # 最小窗口边长 (小于此值会被扩展)
    max_box_size: 512         # 最大窗口边长 (等于 window size)
    dilate_rounds: 5          # 形态学膨胀轮数 (合并间隙≤10px的邻近高熵区域)
    min_windows: 2            # 最少窗口数 (不够则回退 grid 模式)
    max_windows: 8            # 最多窗口数 (按熵排序截断)
    merge_min_distance: 64    # 框中心最小间距 (px), 中心距小于此值的框会被丢弃

# Loss configuration
loss:
  class_select_method: area_k  # Class selection method: "topk" or "area_k"
  topk: 1                    # Number of top classes per pixel (used by "topk" method)
  classes_max_num: 20        # Max unique classes (exceed -> mask unselected pixels)
  classes_min_num: 0         # Min unique classes (below -> weighted sampling to fill)
  temperature: 1.0           # Softmax temperature
  # Area-K parameters (used when class_select_method == "area_k")
  area_k: 5                  # Top-k classes to retain per pixel for area scoring
  area_threshold: 15.0       # Min score_c threshold to select a class
  # Window loss weighting
  window_weighting: entropy       # "none" (uniform) or "entropy" (upweight uncertain windows)
  window_weighting_tau: 1.0    # Temperature for entropy softmax weighting (higher = more uniform)
  # Ignore classes (忽略大面积背景类，不参与类别选择)
  ignore_classes:
    enabled: true                   # 是否开启类别忽略
    class_ids: [0, 2, 8, 13]        # road(0), building(2), vegetation(8), car(13)

# Timestep sampling range for flow matching
timestep_range: [0.25, 0.25]

# Text embedding configuration
text_embedding:
  # To use a template format:
  prompt_template: "a photo of a {}"
  # prompt_template: "a dashcam photo of {}"
  
  # To use custom prompts per category, uncomment the lines below.
  # If 'custom_prompts' is defined, the system will use it and calculate the hash based on its contents.
  # If a class is missing from custom_prompts, it will fallback to using 'prompt_template'.
  # custom_prompts:
  #   "road":          "a road"
  #   "sidewalk":      "a sidewalk"
  #   "building":      "a building"
  #   "wall":          "a concrete wall"
  #   "fence":         "a fence"
  #   "pole":          "a street pole"
  #   "traffic light": "a traffic light"
  #   "traffic sign":  "a traffic sign"
  #   "vegetation":    "trees and bushes"
  #   "terrain":       "grass and dirt ground"
  #   "sky":           "the sky"
  #   "person":        "a pedestrian"
  #   "rider":         "a person on a bicycle"
  #   "car":           "a car"
  #   "truck":         "a truck"
  #   "bus":           "a city bus"
  #   "train":         "a tram on the street"
  #   "motorcycle":    "a motorcycle"
  #   "bicycle":       "a bicycle"

  cache_dir: ./embeddings_cache
